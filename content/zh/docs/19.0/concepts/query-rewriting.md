---
title: Query Rewritting
---

Vitess致力于创造一种用户似乎与单一数据库建立单一连接的假象。实际上，一个单独的查询可能会与多个数据库互动，并且可能使用对同一数据库的多个连接。这里我们
将讨论Vitess做了什么以及这可能对您有何影响。

## Query Splitting
8 一个复杂的查询，如果涉及跨分片(join)可能需要首先从保持vindex查找表的tablet获取信息。然后使用这些信息查询两个不同的分片以获取更多数据，随后将接收到的结
果合并成用户收到的单一结果。MySQL接收到的查询往往只是原始查询的一部分，最终结果将在vtgate层面组装完成。

## Connection Pooling
11 当一个tablet代表用户与MySQL通讯执行查询时，它不会为每个用户使用专用连接，而是会在用户之间共享底层连接。这意味着在会话中存储任何状态都是不安全的，因为>    您不能确定它会继续在同一连接上执行查询，也不能确定这个连接以后是否会被其他用户使用。

## 用户定义的变量
在与MySQL工作时，用户定义的变量会保留在会话状态中。您可以使用SET命令为它们赋值：

```sql
SET @my_user_variable = 'foobar'
```

随后，可以使用例如SELECT的查询：

```sql
> SELECT @my_user_variable;
+-------------------+
| @my_user_variable |
+-------------------+
| foobar            |
+-------------------+
```

如果您通过VTGate执行这些查询，那么第一个SET查询不会被发送到MySQL。而是在VTGate内部进行处理，VTGate会为您维护这个状态。同样，第二个查询也不会下发。像这
类简单的查询，实际上都是直接在VTGate上完全执行的。

如果我们尝试一个更复杂的查询，需要从MySQL获取数据，VTGate会在发送之前重写查询。如果我们要写类似这样的内容：

```sql
WHERE col = @my_user_variable
```

MySQL将看到的是：

```sql
WHERE col = 'foobar'
```

这样一来，在MySQL中评估查询就无需依赖会话状态了。

## 服务器系统变量

用户可能还希望更改MySQL公开的众多不同系统变量中的一个。Vitess通过五种不同方式处理系统变量：
无操作：对于某些设置，Vitess将默默地忽略。这适用于在分片设置中没有太大意义，且不会以有趣方式改变MySQL行为的系统变量。
检查并在未预设情况下失败：这些设置不应更改，但如果SET语句尝试将变量设置为其当前值，Vitess会允许。
不支持：尝试更改这些设置将始终返回错误。
Vitess感知：这些设置会改变Vitess的行为，不会发送到MySQL。
保留连接：对于某些设置，允许设置它们是合理的，但这会使使用共享连接变得更加困难。默认情况下，Vitess会首先应用这些系统变量，然后为该用户保留连接。连接池
对Vitess的性能至关重要，因此这不应成为Vitess上运行应用程序的常态。只需确保应用程序将设置的全局变量与Vitess的设置值相同，Vitess就可以使用连接池。
 此外，Vitess确保@@version包含模拟的MySQL版本和Vitess版本，如：`5.7.9-vitess-14.0.0`。此值可以通过`--mysql_server_version`标志更改。
